<!-- Generated by pkgdown: do not edit by hand -->
<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>slamR: structured latent attribute
models inR — slamR • slamR</title>


<!-- jquery -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
<!-- Bootstrap -->

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous" />

<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script>

<!-- bootstrap-toc -->
<link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script>

<!-- Font Awesome icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous" />

<!-- clipboard.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script>

<!-- headroom.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script>

<!-- pkgdown -->
<link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script>




<meta property="og:title" content="slamR: structured latent attribute
models inR — slamR" />
<meta property="og:description" content="slamR implements scalable algorithms to fit structured latent attribute
models (SLAM) for high-dimensional binary data observed over a single or multiple
 levels of specificity. It works for
1) unknown structural matrix Q,
2) unknown latent
attribute set,
3) one ore more levels of binary data (observed over multiple binary
or non-binary trees)
4) two-parameter or multi-parameter SLAM models
(NB: multi-parameter model under development)

" />






<!-- mathjax -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script>

<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->




  

  

  </head>

  <body data-spy="scroll" data-target="#toc">
    

    <div class="container template-reference-topic">
      <header>
      <div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">slamR</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.2.2</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="../reference/index.html">Reference</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="https://github.com/zhenkewu/slamR/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
      
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      

      </header>

<div class="row">
  <div class="col-md-9 contents">
    <div class="page-header">
    <h1>slamR: <strong>s</strong>tructured <strong>l</strong>atent <strong>a</strong>ttribute
<strong>m</strong>odels in<strong>R</strong></h1>
    <small class="dont-index">Source: <a href='https://github.com/zhenkewu/slamR/blob/master/R/slamR.R'><code>R/slamR.R</code></a></small>
    <div class="hidden name"><code>slamR.Rd</code></div>
    </div>

    <div class="ref-description">
    <p><code>slamR</code> implements scalable algorithms to fit structured latent attribute
models (SLAM) for high-dimensional binary data observed over a single or multiple
 levels of specificity. It works for</p><ul>
<li><p>1) unknown structural matrix Q,</p></li>
<li><p>2) unknown latent
attribute set,</p></li>
<li><p>3) one ore more levels of binary data (observed over multiple binary
or non-binary trees)</p></li>
<li><p>4) two-parameter or multi-parameter SLAM models
(NB: multi-parameter model under development)</p></li>
</ul>

    </div>



    <h2 class="hasAnchor" id="references"><a class="anchor" href="#references"></a>References</h2>

    
<ul>
<li><p>This package partly adapts Matlab programs originally written by <a href='https://sites.google.com/umich.edu/yuqigu/home'>Yuqi Gu</a>. Please
refer to <a href='https://github.com/zhenkewu/slamR'>https://github.com/zhenkewu/slamR</a> for the papers about the model
formulation and algorithm</p></li>
</ul>

    <h2 class="hasAnchor" id="see-also"><a class="anchor" href="#see-also"></a>See also</h2>

    <div class='dont-index'>
<ul>
<li><p><a href='https://github.com/zhenkewu/slamR'>https://github.com/zhenkewu/slamR</a> for the source code
and system/software requirements to use <code>slamR</code> for your data.</p></li>
</ul>
</div>

    <h2 class="hasAnchor" id="examples"><a class="anchor" href="#examples"></a>Examples</h2>
    <div class="ref-examples sourceCode"><pre class='sourceCode r'><code><span class='r-in'><span class='co'># compare DMR with flattened analysis</span></span>
<span class='r-in'><span class='co'># Mar 04, 2020</span></span>
<span class='r-in'></span>
<span class='r-in'><span class='kw'>if</span> <span class='op'>(</span><span class='cn'>FALSE</span><span class='op'>)</span> <span class='op'>{</span></span>
<span class='r-in'>  <span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://github.com/zhenkewu/slamR'>slamR</a></span><span class='op'>)</span></span>
<span class='r-in'>  <span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'>gplots</span><span class='op'>)</span> <span class='co'># heatmap.2</span></span>
<span class='r-in'>  <span class='fu'><a href='https://rdrr.io/r/base/rm.html'>rm</a></span><span class='op'>(</span>list<span class='op'>=</span><span class='fu'><a href='https://rdrr.io/r/base/ls.html'>ls</a></span><span class='op'>(</span><span class='op'>)</span><span class='op'>)</span></span>
<span class='r-in'></span>
<span class='r-in'>  <span class='va'>production_dir</span> <span class='op'>&lt;-</span> <span class='st'>"/Users/zhenkewu/Dropbox/OptumInsight\ Data\ and\ Restricted\</span>
<span class='r-in'>Latent\ Class\ Model/DMR_R_code/"</span></span>
<span class='r-in'></span>
<span class='r-in'>  <span class='va'>N</span> <span class='op'>&lt;-</span> <span class='fl'>15000</span> <span class='co'># sample size.</span></span>
<span class='r-in'>  <span class='va'>err_prob</span> <span class='op'>&lt;-</span> <span class='fl'>0.2</span> <span class='co'># noise level.</span></span>
<span class='r-in'></span>
<span class='r-in'>  <span class='co'># shrinkage algorithm parameters:</span></span>
<span class='r-in'>  <span class='va'>thres_c</span> <span class='op'>&lt;-</span> <span class='fl'>0.01</span>  <span class='co'># used in the E step (modified EM for log-type penalized likelihood).</span></span>
<span class='r-in'>  <span class='va'>thres</span>   <span class='op'>&lt;-</span> <span class='fl'>0.5</span><span class='op'>/</span><span class='va'>N</span> <span class='co'># for thresholding at the end of the modified EM algoritm or</span></span>
<span class='r-in'>  <span class='co'># general fractional power (equivalent formulation of pen-likelihood)</span></span>
<span class='r-in'>  <span class='co'># variational (E step for attributes use Dirichlet variational family) EM.</span></span>
<span class='r-in'></span>
<span class='r-in'>  <span class='va'>C1</span> <span class='op'>&lt;-</span> <span class='fl'>3</span> <span class='co'># level 1 # of latent attribute patterns.</span></span>
<span class='r-in'></span>
<span class='r-in'></span>
<span class='r-in'>  <span class='co'># Simulation settings:</span></span>
<span class='r-in'>  <span class='va'>A_set1</span>   <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/cbind.html'>rbind</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>0</span>,<span class='fl'>0</span>,<span class='fl'>1</span><span class='op'>)</span>,<span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>1</span>,<span class='fl'>1</span>,<span class='fl'>0</span><span class='op'>)</span>,<span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>1</span>,<span class='fl'>1</span>,<span class='fl'>1</span><span class='op'>)</span><span class='op'>)</span></span>
<span class='r-in'>  <span class='va'>Q1_small</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/cbind.html'>rbind</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/diag.html'>diag</a></span><span class='op'>(</span><span class='fl'>1</span>,<span class='fl'>3</span><span class='op'>)</span>,<span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>1</span>,<span class='fl'>1</span>,<span class='fl'>0</span><span class='op'>)</span>,<span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>0</span>,<span class='fl'>0</span>,<span class='fl'>1</span><span class='op'>)</span><span class='op'>)</span></span>
<span class='r-in'></span>
<span class='r-in'>  <span class='fu'><a href='https://rdrr.io/r/base/t.html'>t</a></span><span class='op'>(</span><span class='fu'><a href='get_ideal_resp.html'>get_ideal_resp</a></span><span class='op'>(</span><span class='va'>Q1_small</span>,<span class='va'>A_set1</span><span class='op'>)</span><span class='op'>)</span></span>
<span class='r-in'></span>
<span class='r-in'>  <span class='va'>Q1</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/do.call.html'>do.call</a></span><span class='op'>(</span><span class='st'>"rbind"</span>, <span class='fu'><a href='https://rdrr.io/r/base/rep.html'>rep</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/list.html'>list</a></span><span class='op'>(</span><span class='va'>Q1_small</span><span class='op'>)</span>, <span class='fl'>20</span><span class='op'>)</span><span class='op'>)</span></span>
<span class='r-in'></span>
<span class='r-in'>  <span class='va'>J1</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/nrow.html'>nrow</a></span><span class='op'>(</span><span class='va'>Q1</span><span class='op'>)</span> <span class='co'># level 1 dimension, J1 (here = 200)</span></span>
<span class='r-in'>  <span class='va'>K1</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/nrow.html'>ncol</a></span><span class='op'>(</span><span class='va'>Q1</span><span class='op'>)</span></span>
<span class='r-in'></span>
<span class='r-in'>  <span class='co'># level 2 structural matrix:</span></span>
<span class='r-in'>  <span class='va'>Q2</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/vector.html'>vector</a></span><span class='op'>(</span><span class='st'>"list"</span>,<span class='fl'>3</span><span class='op'>)</span></span>
<span class='r-in'>  <span class='va'>Q2</span><span class='op'>[[</span><span class='fl'>1</span><span class='op'>]</span><span class='op'>]</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/do.call.html'>do.call</a></span><span class='op'>(</span><span class='st'>"rbind"</span>, <span class='fu'><a href='https://rdrr.io/r/base/rep.html'>rep</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/list.html'>list</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/cbind.html'>rbind</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/diag.html'>diag</a></span><span class='op'>(</span><span class='fl'>1</span>,<span class='fl'>2</span><span class='op'>)</span>,<span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>1</span>,<span class='fl'>0</span><span class='op'>)</span>,<span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>0</span>,<span class='fl'>1</span><span class='op'>)</span>,<span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>1</span>,<span class='fl'>1</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span>, <span class='fl'>200</span><span class='op'>)</span><span class='op'>)</span></span>
<span class='r-in'>  <span class='va'>Q2</span><span class='op'>[[</span><span class='fl'>2</span><span class='op'>]</span><span class='op'>]</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/do.call.html'>do.call</a></span><span class='op'>(</span><span class='st'>"rbind"</span>, <span class='fu'><a href='https://rdrr.io/r/base/rep.html'>rep</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/list.html'>list</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/cbind.html'>rbind</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/diag.html'>diag</a></span><span class='op'>(</span><span class='fl'>1</span>,<span class='fl'>2</span><span class='op'>)</span>,<span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>1</span>,<span class='fl'>0</span><span class='op'>)</span>,<span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>1</span>,<span class='fl'>1</span><span class='op'>)</span>,<span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>1</span>,<span class='fl'>1</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span>, <span class='fl'>200</span><span class='op'>)</span><span class='op'>)</span></span>
<span class='r-in'>  <span class='va'>Q2</span><span class='op'>[[</span><span class='fl'>3</span><span class='op'>]</span><span class='op'>]</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/do.call.html'>do.call</a></span><span class='op'>(</span><span class='st'>"rbind"</span>, <span class='fu'><a href='https://rdrr.io/r/base/rep.html'>rep</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/list.html'>list</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/cbind.html'>rbind</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/diag.html'>diag</a></span><span class='op'>(</span><span class='fl'>1</span>,<span class='fl'>2</span><span class='op'>)</span>,<span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>0</span>,<span class='fl'>1</span><span class='op'>)</span>,<span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>1</span>,<span class='fl'>1</span><span class='op'>)</span>,<span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>1</span>,<span class='fl'>1</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span>, <span class='fl'>200</span><span class='op'>)</span><span class='op'>)</span></span>
<span class='r-in'></span>
<span class='r-in'>  <span class='va'>J2</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/nrow.html'>nrow</a></span><span class='op'>(</span><span class='va'>Q2</span><span class='op'>[[</span><span class='fl'>1</span><span class='op'>]</span><span class='op'>]</span><span class='op'>)</span></span>
<span class='r-in'>  <span class='va'>K2</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/nrow.html'>ncol</a></span><span class='op'>(</span><span class='va'>Q2</span><span class='op'>[[</span><span class='fl'>1</span><span class='op'>]</span><span class='op'>]</span><span class='op'>)</span> <span class='co'># here we use identical K2 in the simulation, though need not be.</span></span>
<span class='r-in'></span>
<span class='r-in'></span>
<span class='r-in'>  <span class='co'># specify the taxonomy via D_mat</span></span>
<span class='r-in'>  <span class='va'>D_mat</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/matrix.html'>matrix</a></span><span class='op'>(</span><span class='fl'>0</span>,<span class='va'>J1</span>,<span class='va'>J2</span><span class='op'>)</span></span>
<span class='r-in'>  <span class='va'>J_ratio</span> <span class='op'>&lt;-</span> <span class='va'>J2</span><span class='op'>/</span><span class='va'>J1</span></span>
<span class='r-in'>  <span class='kw'>for</span> <span class='op'>(</span><span class='va'>j1</span> <span class='kw'>in</span> <span class='fl'>1</span><span class='op'>:</span><span class='va'>J1</span><span class='op'>)</span><span class='op'>{</span></span>
<span class='r-in'>    <span class='va'>D_mat</span><span class='op'>[</span><span class='va'>j1</span>,<span class='op'>(</span><span class='op'>(</span><span class='va'>j1</span><span class='op'>-</span><span class='fl'>1</span><span class='op'>)</span><span class='op'>*</span><span class='va'>J_ratio</span><span class='op'>+</span><span class='fl'>1</span><span class='op'>)</span><span class='op'>:</span><span class='op'>(</span><span class='va'>j1</span><span class='op'>*</span><span class='va'>J_ratio</span><span class='op'>)</span><span class='op'>]</span> <span class='op'>&lt;-</span> <span class='fl'>1</span></span>
<span class='r-in'>  <span class='op'>}</span></span>
<span class='r-in'></span>
<span class='r-in'>  <span class='fu'>heatmap.2</span><span class='op'>(</span><span class='va'>D_mat</span>,dendrogram<span class='op'>=</span><span class='st'>'none'</span>, Rowv<span class='op'>=</span><span class='cn'>FALSE</span>, Colv<span class='op'>=</span><span class='cn'>FALSE</span>,trace<span class='op'>=</span><span class='st'>'none'</span><span class='op'>)</span></span>
<span class='r-in'></span>
<span class='r-in'>  <span class='co'># model parameters:</span></span>
<span class='r-in'>  <span class='va'>p1</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>0.5</span>,<span class='fl'>0.3</span>,<span class='fl'>0.2</span><span class='op'>)</span> <span class='co'># in paper c(0.3,0.2,0.5)</span></span>
<span class='r-in'>  <span class='va'>p2</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/vector.html'>vector</a></span><span class='op'>(</span><span class='st'>"list"</span>,<span class='va'>C1</span><span class='op'>)</span></span>
<span class='r-in'></span>
<span class='r-in'>  <span class='co'># design 1:</span></span>
<span class='r-in'>  <span class='va'>A_set2</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/vector.html'>vector</a></span><span class='op'>(</span><span class='st'>"list"</span>,<span class='va'>C1</span><span class='op'>)</span></span>
<span class='r-in'>  <span class='va'>A_set2</span><span class='op'>[[</span><span class='fl'>1</span><span class='op'>]</span><span class='op'>]</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/cbind.html'>rbind</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>0</span>,<span class='fl'>0</span><span class='op'>)</span>,<span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>0</span>,<span class='fl'>1</span><span class='op'>)</span>,<span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>1</span>,<span class='fl'>0</span><span class='op'>)</span>,<span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>1</span>,<span class='fl'>1</span><span class='op'>)</span><span class='op'>)</span></span>
<span class='r-in'>  <span class='va'>A_set2</span><span class='op'>[[</span><span class='fl'>2</span><span class='op'>]</span><span class='op'>]</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/cbind.html'>rbind</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>0</span>,<span class='fl'>0</span><span class='op'>)</span>,<span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>0</span>,<span class='fl'>1</span><span class='op'>)</span>,<span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>1</span>,<span class='fl'>1</span><span class='op'>)</span><span class='op'>)</span></span>
<span class='r-in'>  <span class='va'>A_set2</span><span class='op'>[[</span><span class='fl'>3</span><span class='op'>]</span><span class='op'>]</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/cbind.html'>rbind</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>0</span>,<span class='fl'>0</span><span class='op'>)</span>,<span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>1</span>,<span class='fl'>0</span><span class='op'>)</span>,<span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>1</span>,<span class='fl'>1</span><span class='op'>)</span><span class='op'>)</span></span>
<span class='r-in'></span>
<span class='r-in'>  <span class='va'>p2</span><span class='op'>[[</span><span class='fl'>1</span><span class='op'>]</span><span class='op'>]</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>0.3</span>,<span class='fl'>0.2</span>,<span class='fl'>0.3</span>,<span class='fl'>0.2</span><span class='op'>)</span></span>
<span class='r-in'>  <span class='va'>p2</span><span class='op'>[[</span><span class='fl'>2</span><span class='op'>]</span><span class='op'>]</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>0.4</span>,<span class='fl'>0.2</span>,<span class='fl'>0.4</span><span class='op'>)</span></span>
<span class='r-in'>  <span class='va'>p2</span><span class='op'>[[</span><span class='fl'>3</span><span class='op'>]</span><span class='op'>]</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>0.3</span>,<span class='fl'>0.3</span>,<span class='fl'>0.4</span><span class='op'>)</span></span>
<span class='r-in'></span>
<span class='r-in'>  <span class='va'>c1</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/rep.html'>rep</a></span><span class='op'>(</span><span class='op'>(</span><span class='fl'>1</span><span class='op'>-</span><span class='va'>err_prob</span><span class='op'>)</span>,<span class='va'>J1</span><span class='op'>)</span></span>
<span class='r-in'>  <span class='va'>g1</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/rep.html'>rep</a></span><span class='op'>(</span><span class='va'>err_prob</span>,<span class='va'>J1</span><span class='op'>)</span></span>
<span class='r-in'></span>
<span class='r-in'>  <span class='co'># let the probabilities of different classes in the first</span></span>
<span class='r-in'>  <span class='co'># level to have different item parameters at level 2:</span></span>
<span class='r-in'>  <span class='va'>c2</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/vector.html'>vector</a></span><span class='op'>(</span><span class='st'>"list"</span>,<span class='va'>C1</span><span class='op'>)</span></span>
<span class='r-in'>  <span class='kw'>for</span> <span class='op'>(</span><span class='va'>cc</span> <span class='kw'>in</span> <span class='fl'>1</span><span class='op'>:</span><span class='va'>C1</span><span class='op'>)</span><span class='op'>{</span></span>
<span class='r-in'>    <span class='va'>c2</span><span class='op'>[[</span><span class='va'>cc</span><span class='op'>]</span><span class='op'>]</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/rep.html'>rep</a></span><span class='op'>(</span><span class='fl'>1</span><span class='op'>-</span><span class='va'>err_prob</span>,<span class='va'>J2</span><span class='op'>)</span></span>
<span class='r-in'>  <span class='op'>}</span></span>
<span class='r-in'>  <span class='va'>g2</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/vector.html'>vector</a></span><span class='op'>(</span><span class='st'>"list"</span>,<span class='va'>C1</span><span class='op'>)</span></span>
<span class='r-in'>  <span class='kw'>for</span> <span class='op'>(</span><span class='va'>cc</span> <span class='kw'>in</span> <span class='fl'>1</span><span class='op'>:</span><span class='va'>C1</span><span class='op'>)</span><span class='op'>{</span></span>
<span class='r-in'>    <span class='va'>g2</span><span class='op'>[[</span><span class='va'>cc</span><span class='op'>]</span><span class='op'>]</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/rep.html'>rep</a></span><span class='op'>(</span><span class='va'>err_prob</span>,<span class='va'>J2</span><span class='op'>)</span></span>
<span class='r-in'>  <span class='op'>}</span></span>
<span class='r-in'></span>
<span class='r-in'>  <span class='fu'><a href='make_list.html'>make_list</a></span><span class='op'>(</span><span class='va'>N</span>,<span class='va'>J1</span>,<span class='va'>J2</span>,<span class='va'>K1</span>,<span class='va'>K2</span><span class='op'>)</span></span>
<span class='r-in'></span>
<span class='r-in'>  <span class='co'>#</span></span>
<span class='r-in'>  <span class='co'># generate data</span></span>
<span class='r-in'>  <span class='co'>#</span></span>
<span class='r-in'></span>
<span class='r-in'>  <span class='co'># level 1: coarser level</span></span>
<span class='r-in'>  <span class='fu'><a href='https://rdrr.io/r/base/Random.html'>set.seed</a></span><span class='op'>(</span><span class='fl'>0513</span><span class='op'>)</span></span>
<span class='r-in'>  <span class='va'>res</span> <span class='op'>&lt;-</span> <span class='fu'><a href='generate_X_fromA.html'>generate_X_fromA</a></span><span class='op'>(</span><span class='va'>N</span>,<span class='va'>A_set1</span>,<span class='va'>p1</span>,<span class='va'>Q1</span>,<span class='va'>c1</span>,<span class='va'>g1</span><span class='op'>)</span></span>
<span class='r-in'>  <span class='va'>X1</span> <span class='op'>&lt;-</span> <span class='va'>res</span><span class='op'>$</span><span class='va'>X</span></span>
<span class='r-in'>  <span class='va'>Z1</span> <span class='op'>&lt;-</span> <span class='va'>res</span><span class='op'>$</span><span class='va'>Z</span></span>
<span class='r-in'>  <span class='va'>X_true1</span> <span class='op'>&lt;-</span> <span class='va'>res</span><span class='op'>$</span><span class='va'>X_true</span></span>
<span class='r-in'>  <span class='fu'><a href='https://rdrr.io/r/base/rm.html'>rm</a></span><span class='op'>(</span><span class='st'>"res"</span><span class='op'>)</span></span>
<span class='r-in'></span>
<span class='r-in'>  <span class='co'># level 2: finer level</span></span>
<span class='r-in'>  <span class='va'>X2</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/matrix.html'>matrix</a></span><span class='op'>(</span><span class='fl'>0</span>,nrow<span class='op'>=</span><span class='va'>N</span>,ncol<span class='op'>=</span><span class='va'>J2</span><span class='op'>)</span></span>
<span class='r-in'>  <span class='va'>Z2</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/matrix.html'>matrix</a></span><span class='op'>(</span><span class='fl'>0</span>,nrow<span class='op'>=</span><span class='va'>N</span>,ncol<span class='op'>=</span><span class='va'>K2</span><span class='op'>)</span></span>
<span class='r-in'></span>
<span class='r-in'>  <span class='kw'>for</span> <span class='op'>(</span><span class='va'>cc</span> <span class='kw'>in</span> <span class='fl'>1</span><span class='op'>:</span><span class='va'>C1</span><span class='op'>)</span><span class='op'>{</span></span>
<span class='r-in'>    <span class='va'>ind_cc</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/which.html'>which</a></span><span class='op'>(</span><span class='fu'><a href='bin2ind.html'>bin2ind</a></span><span class='op'>(</span><span class='va'>Z1</span><span class='op'>)</span><span class='op'>==</span><span class='fu'><a href='bin2ind.html'>bin2ind</a></span><span class='op'>(</span><span class='va'>A_set1</span><span class='op'>[</span><span class='va'>cc</span>,<span class='op'>]</span><span class='op'>)</span><span class='op'>)</span></span>
<span class='r-in'>    <span class='fu'><a href='https://rdrr.io/r/base/Random.html'>set.seed</a></span><span class='op'>(</span><span class='fl'>0513</span><span class='op'>)</span></span>
<span class='r-in'>    <span class='va'>res</span> <span class='op'>&lt;-</span> <span class='fu'><a href='generate_X_tax2.html'>generate_X_tax2</a></span><span class='op'>(</span><span class='va'>X1</span><span class='op'>[</span><span class='va'>ind_cc</span>,,drop<span class='op'>=</span><span class='cn'>FALSE</span><span class='op'>]</span>,</span>
<span class='r-in'>                           <span class='va'>A_set2</span><span class='op'>[[</span><span class='va'>cc</span><span class='op'>]</span><span class='op'>]</span>,</span>
<span class='r-in'>                           <span class='va'>D_mat</span>,</span>
<span class='r-in'>                           <span class='va'>p2</span><span class='op'>[[</span><span class='va'>cc</span><span class='op'>]</span><span class='op'>]</span>, <span class='va'>Q2</span><span class='op'>[[</span><span class='va'>cc</span><span class='op'>]</span><span class='op'>]</span>,<span class='va'>c2</span><span class='op'>[[</span><span class='va'>cc</span><span class='op'>]</span><span class='op'>]</span>,<span class='va'>g2</span><span class='op'>[[</span><span class='va'>cc</span><span class='op'>]</span><span class='op'>]</span><span class='op'>)</span></span>
<span class='r-in'></span>
<span class='r-in'>    <span class='va'>X2</span><span class='op'>[</span><span class='va'>ind_cc</span>,<span class='op'>]</span> <span class='op'>&lt;-</span> <span class='va'>res</span><span class='op'>$</span><span class='va'>X2</span></span>
<span class='r-in'>    <span class='va'>Z2</span><span class='op'>[</span><span class='va'>ind_cc</span>,<span class='op'>]</span> <span class='op'>&lt;-</span> <span class='va'>res</span><span class='op'>$</span><span class='va'>Z</span></span>
<span class='r-in'>  <span class='op'>}</span></span>
<span class='r-in'></span>
<span class='r-in'>  <span class='fu'><a href='https://rdrr.io/r/base/rm.html'>rm</a></span><span class='op'>(</span><span class='st'>"res"</span><span class='op'>)</span></span>
<span class='r-in'>  <span class='co'># model fitting:</span></span>
<span class='r-in'></span>
<span class='r-in'>  <span class='co'># stage 1 fitting:</span></span>
<span class='r-in'>  <span class='fu'><a href='https://rdrr.io/r/base/Random.html'>set.seed</a></span><span class='op'>(</span><span class='fl'>0513</span><span class='op'>)</span></span>
<span class='r-in'>  <span class='va'>res</span> <span class='op'>&lt;-</span> <span class='fu'><a href='get_initial_s.html'>get_initial_s</a></span><span class='op'>(</span><span class='va'>N</span>,<span class='va'>Q1</span>,<span class='va'>Z1</span><span class='op'>)</span></span>
<span class='r-in'>  <span class='va'>Q_ini1</span> <span class='op'>&lt;-</span> <span class='va'>res</span><span class='op'>$</span><span class='va'>Q_ini</span></span>
<span class='r-in'>  <span class='va'>Z_ini1</span> <span class='op'>&lt;-</span> <span class='va'>res</span><span class='op'>$</span><span class='va'>Z_ini</span></span>
<span class='r-in'></span>
<span class='r-in'>  <span class='va'>max_iter</span> <span class='op'>&lt;-</span> <span class='fl'>50</span></span>
<span class='r-in'></span>
<span class='r-in'></span>
<span class='r-in'>  <span class='co'># This is only for tunning:</span></span>
<span class='r-in'>  <span class='co'>#X=X1;Z_ini=Z_ini1;Q_ini=Q_ini1;max_iter=50</span></span>
<span class='r-in'>  <span class='va'>time1</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/Sys.time.html'>Sys.time</a></span><span class='op'>(</span><span class='op'>)</span></span>
<span class='r-in'>  <span class='va'>res</span> <span class='op'>&lt;-</span> <span class='fu'><a href='adg_em.html'>adg_em</a></span><span class='op'>(</span><span class='va'>X1</span>,<span class='va'>Z_ini1</span>,<span class='va'>Q_ini1</span>,<span class='va'>max_iter</span>,<span class='va'>err_prob</span><span class='op'>)</span></span>
<span class='r-in'>  <span class='fu'><a href='https://rdrr.io/r/base/Sys.time.html'>Sys.time</a></span><span class='op'>(</span><span class='op'>)</span><span class='op'>-</span><span class='va'>time1</span></span>
<span class='r-in'></span>
<span class='r-in'>  <span class='va'>Q_est</span> <span class='op'>&lt;-</span> <span class='va'>res</span><span class='op'>$</span><span class='va'>Q_arr</span><span class='op'>[[</span><span class='fu'><a href='https://rdrr.io/r/base/length.html'>length</a></span><span class='op'>(</span><span class='va'>res</span><span class='op'>$</span><span class='va'>Q_arr</span><span class='op'>)</span><span class='op'>]</span><span class='op'>]</span> <span class='co'># still may not identically recover Q?</span></span>
<span class='r-in'>  <span class='va'>Z_est</span> <span class='op'>&lt;-</span> <span class='va'>res</span><span class='op'>$</span><span class='va'>Z_est</span></span>
<span class='r-in'>  <span class='va'>Z_candi</span> <span class='op'>&lt;-</span> <span class='va'>res</span><span class='op'>$</span><span class='va'>Z_candi</span></span>
<span class='r-in'>  <span class='fu'><a href='https://rdrr.io/r/base/rm.html'>rm</a></span><span class='op'>(</span><span class='va'>res</span><span class='op'>)</span></span>
<span class='r-in'></span>
<span class='r-in'>  <span class='fu'><a href='check_complete.html'>check_complete</a></span><span class='op'>(</span><span class='va'>Q_est</span><span class='op'>)</span></span>
<span class='r-in'>  <span class='co'># if not complete force to be complete.</span></span>
<span class='r-in'>  <span class='kw'>if</span> <span class='op'>(</span><span class='fu'><a href='check_complete.html'>check_complete</a></span><span class='op'>(</span><span class='va'>Q_est</span><span class='op'>)</span><span class='op'>$</span><span class='va'>is_complete</span><span class='op'>==</span><span class='fl'>0</span><span class='op'>)</span><span class='op'>{</span></span>
<span class='r-in'>    <span class='va'>Q_est</span><span class='op'>[</span><span class='fl'>1</span><span class='op'>:</span><span class='va'>K1</span>,<span class='op'>]</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/diag.html'>diag</a></span><span class='op'>(</span><span class='fl'>1</span>,<span class='va'>K1</span><span class='op'>)</span></span>
<span class='r-in'>  <span class='op'>}</span></span>
<span class='r-in'>  <span class='co'># ZW: does thia matter for estimating Q by forcing completeness?</span></span>
<span class='r-in'></span>
<span class='r-in'></span>
<span class='r-in'>  <span class='co'>## checking:</span></span>
<span class='r-in'>  <span class='fu'><a href='https://rdrr.io/r/base/cat.html'>cat</a></span><span class='op'>(</span><span class='st'>"==look at estimated Q\n=="</span><span class='op'>)</span></span>
<span class='r-in'>  <span class='fu'><a href='https://rdrr.io/r/base/sum.html'>sum</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/sum.html'>sum</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/MathFun.html'>abs</a></span><span class='op'>(</span><span class='fu'><a href='get_ideal_resp.html'>get_ideal_resp</a></span><span class='op'>(</span><span class='va'>Q1</span>,<span class='va'>A_set1</span><span class='op'>)</span><span class='op'>-</span><span class='fu'><a href='get_ideal_resp.html'>get_ideal_resp</a></span><span class='op'>(</span><span class='va'>Q_est</span>,<span class='va'>A_set1</span><span class='op'>)</span><span class='op'>)</span><span class='op'>&gt;</span><span class='fl'>0</span><span class='op'>)</span><span class='op'>)</span></span>
<span class='r-in'></span>
<span class='r-in'>  <span class='fu'><a href='https://rdrr.io/r/base/cat.html'>cat</a></span><span class='op'>(</span><span class='st'>"==look at initial Q\n=="</span><span class='op'>)</span></span>
<span class='r-in'>  <span class='fu'><a href='https://rdrr.io/r/base/sum.html'>sum</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/sum.html'>sum</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/MathFun.html'>abs</a></span><span class='op'>(</span><span class='fu'><a href='get_ideal_resp.html'>get_ideal_resp</a></span><span class='op'>(</span><span class='va'>Q1</span>,<span class='va'>A_set1</span><span class='op'>)</span><span class='op'>-</span><span class='fu'><a href='get_ideal_resp.html'>get_ideal_resp</a></span><span class='op'>(</span><span class='va'>Q_ini1</span>,<span class='va'>A_set1</span><span class='op'>)</span><span class='op'>)</span><span class='op'>&gt;</span><span class='fl'>0</span><span class='op'>)</span><span class='op'>)</span></span>
<span class='r-in'></span>
<span class='r-in'>  <span class='co'>#estimated unique latent attribute profiles:</span></span>
<span class='r-in'>  <span class='fu'><a href='https://rdrr.io/r/base/unique.html'>unique</a></span><span class='op'>(</span><span class='va'>Z_est</span><span class='op'>)</span></span>
<span class='r-in'>  <span class='fu'><a href='https://rdrr.io/r/base/table.html'>table</a></span><span class='op'>(</span><span class='fu'><a href='bin2ind.html'>bin2ind</a></span><span class='op'>(</span><span class='va'>Z_est</span><span class='op'>)</span><span class='op'>)</span> <span class='co'># this is the candidates after screening; input for shrinkage.</span></span>
<span class='r-in'>  <span class='co'>## end of checking</span></span>
<span class='r-in'></span>
<span class='r-in'>  <span class='co'># shrinkage estimation at coarser level (level 1):</span></span>
<span class='r-in'>  <span class='va'>c_ini1</span> <span class='op'>&lt;-</span> <span class='va'>c1</span></span>
<span class='r-in'>  <span class='va'>g_ini1</span> <span class='op'>&lt;-</span> <span class='va'>g1</span></span>
<span class='r-in'></span>
<span class='r-in'>  <span class='va'>lambda_vec</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/seq.html'>seq</a></span><span class='op'>(</span><span class='op'>-</span><span class='fl'>0.2</span>,<span class='op'>-</span><span class='fl'>4.2</span>,by<span class='op'>=</span><span class='op'>-</span><span class='fl'>0.4</span><span class='op'>)</span> <span class='co'># grid of lambda values in pen-likelihood formulation.</span></span>
<span class='r-in'></span>
<span class='r-in'>  <span class='va'>res</span> <span class='op'>&lt;-</span> <span class='fu'><a href='perform_shrink.html'>perform_shrink</a></span><span class='op'>(</span><span class='va'>X1</span>, <span class='va'>Q_est</span>, <span class='va'>Z_candi</span>,</span>
<span class='r-in'>                        <span class='va'>lambda_vec</span>, <span class='va'>c_ini1</span>, <span class='va'>g_ini1</span>, <span class='fl'>0</span><span class='op'>)</span></span>
<span class='r-in'></span>
<span class='r-in'>  <span class='va'>A_final1</span> <span class='op'>&lt;-</span> <span class='va'>res</span><span class='op'>$</span><span class='va'>A_final</span></span>
<span class='r-in'></span>
<span class='r-in'>  <span class='fu'><a href='https://rdrr.io/r/base/rm.html'>rm</a></span><span class='op'>(</span><span class='va'>res</span><span class='op'>)</span></span>
<span class='r-in'></span>
<span class='r-in'>  <span class='va'>res</span> <span class='op'>&lt;-</span> <span class='fu'><a href='get_em_classify.html'>get_em_classify</a></span><span class='op'>(</span><span class='va'>X1</span>,<span class='va'>Q_est</span>,<span class='va'>A_final1</span>,<span class='va'>err_prob</span><span class='op'>)</span></span>
<span class='r-in'>  <span class='va'>Z_shrink1</span> <span class='op'>&lt;-</span> <span class='va'>res</span><span class='op'>$</span><span class='va'>Z_shrink</span></span>
<span class='r-in'></span>
<span class='r-in'></span>
<span class='r-in'>  <span class='va'>pattern1</span> <span class='op'>&lt;-</span> <span class='va'>A_final1</span></span>
<span class='r-in'>  <span class='va'>profile1</span> <span class='op'>&lt;-</span> <span class='va'>res</span><span class='op'>$</span><span class='va'>Z_shrink</span></span>
<span class='r-in'>  <span class='va'>Q1_est</span>   <span class='op'>&lt;-</span> <span class='va'>Q_est</span></span>
<span class='r-in'></span>
<span class='r-in'>  <span class='co'># end: 1st coarser fitting &lt;---------------------------- end of first level fitting.</span></span>
<span class='r-in'></span>
<span class='r-in'>  <span class='co'>#</span></span>
<span class='r-in'>  <span class='co'># begin 2nd finer resolution fitting:</span></span>
<span class='r-in'>  <span class='co'>#</span></span>
<span class='r-in'>  <span class='fu'><a href='https://rdrr.io/r/base/table.html'>table</a></span><span class='op'>(</span><span class='fu'><a href='bin2ind.html'>bin2ind</a></span><span class='op'>(</span><span class='va'>Z1</span><span class='op'>)</span><span class='op'>)</span>        <span class='co'># true profiles.</span></span>
<span class='r-in'>  <span class='fu'><a href='https://rdrr.io/r/base/table.html'>table</a></span><span class='op'>(</span><span class='fu'><a href='bin2ind.html'>bin2ind</a></span><span class='op'>(</span><span class='va'>Z_shrink1</span><span class='op'>)</span><span class='op'>)</span> <span class='co'># estimated. identical? this is excellent!</span></span>
<span class='r-in'></span>
<span class='r-in'>  <span class='va'>C1_hat</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/nrow.html'>nrow</a></span><span class='op'>(</span><span class='va'>A_final1</span><span class='op'>)</span></span>
<span class='r-in'>  <span class='va'>pattern2_est</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/vector.html'>vector</a></span><span class='op'>(</span><span class='st'>"list"</span>,<span class='va'>C1_hat</span><span class='op'>)</span></span>
<span class='r-in'>  <span class='va'>profile2_est</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/vector.html'>vector</a></span><span class='op'>(</span><span class='st'>"list"</span>,<span class='va'>C1_hat</span><span class='op'>)</span></span>
<span class='r-in'>  <span class='va'>Q2_est</span>       <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/vector.html'>vector</a></span><span class='op'>(</span><span class='st'>"list"</span>,<span class='va'>C1_hat</span><span class='op'>)</span></span>
<span class='r-in'></span>
<span class='r-in'>  <span class='va'>Z_ini2</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/matrix.html'>matrix</a></span><span class='op'>(</span><span class='fl'>0</span>,nrow<span class='op'>=</span><span class='va'>N</span>,ncol<span class='op'>=</span><span class='va'>K2</span><span class='op'>)</span></span>
<span class='r-in'>  <span class='va'>Z_shrink2</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/matrix.html'>matrix</a></span><span class='op'>(</span><span class='fl'>0</span>,nrow<span class='op'>=</span><span class='va'>N</span>,ncol<span class='op'>=</span><span class='va'>K2</span><span class='op'>)</span> <span class='co'># currently we are assuming the same K2.</span></span>
<span class='r-in'></span>
<span class='r-in'></span>
<span class='r-in'>  <span class='va'>must_maxiter</span> <span class='op'>&lt;-</span> <span class='fl'>0</span></span>
<span class='r-in'>  <span class='fu'><a href='https://rdrr.io/r/base/Random.html'>set.seed</a></span><span class='op'>(</span><span class='fl'>0513</span><span class='op'>)</span></span>
<span class='r-in'></span>
<span class='r-in'>  <span class='kw'>for</span> <span class='op'>(</span><span class='va'>cc</span> <span class='kw'>in</span> <span class='fl'>1</span><span class='op'>:</span><span class='va'>C1_hat</span><span class='op'>)</span><span class='op'>{</span></span>
<span class='r-in'>    <span class='va'>ind_cc_est</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/apply.html'>apply</a></span><span class='op'>(</span><span class='va'>Z_shrink1</span>,<span class='fl'>1</span>,<span class='kw'>function</span><span class='op'>(</span><span class='va'>v</span><span class='op'>)</span> <span class='fu'><a href='https://rdrr.io/r/base/all.html'>all</a></span><span class='op'>(</span><span class='va'>v</span><span class='op'>==</span><span class='va'>A_final1</span><span class='op'>[</span><span class='va'>cc</span>,<span class='op'>]</span><span class='op'>)</span><span class='op'>)</span></span>
<span class='r-in'>    <span class='va'>X2_cc</span> <span class='op'>&lt;-</span> <span class='va'>X2</span><span class='op'>[</span><span class='va'>ind_cc_est</span>,,drop<span class='op'>=</span><span class='cn'>FALSE</span><span class='op'>]</span></span>
<span class='r-in'>    <span class='va'>X1_cc</span> <span class='op'>&lt;-</span> <span class='va'>X1</span><span class='op'>[</span><span class='va'>ind_cc_est</span>,,drop<span class='op'>=</span><span class='cn'>FALSE</span><span class='op'>]</span></span>
<span class='r-in'></span>
<span class='r-in'>    <span class='co'>#res &lt;- get_initial_n(sum(ind_cc_est),Q2[[cc]],Z2[ind_cc_est,,drop=FALSE])</span></span>
<span class='r-in'>    <span class='co'># function not programmed.</span></span>
<span class='r-in'>    <span class='co'># caveat: the cc here may not match with the cc in the orginal simulation</span></span>
<span class='r-in'>    <span class='co'># A_final1 rows may be ordered differently than A_set1. Need to match!</span></span>
<span class='r-in'>    <span class='co'># in matlab - unique automatically order by row; A_set1 is ordered by row.</span></span>
<span class='r-in'></span>
<span class='r-in'></span>
<span class='r-in'></span>
<span class='r-in'>    <span class='co'>#initialization matters: if using wrong Q2, Z2, might have problems:</span></span>
<span class='r-in'>    <span class='co'># the final Z_est might not be in Z_ini, for example.</span></span>
<span class='r-in'>    <span class='va'>res</span> <span class='op'>&lt;-</span> <span class='fu'><a href='get_initial_n.html'>get_initial_n</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/sum.html'>sum</a></span><span class='op'>(</span><span class='va'>ind_cc_est</span><span class='op'>)</span>,<span class='va'>Q2</span><span class='op'>[[</span><span class='va'>cc</span><span class='op'>]</span><span class='op'>]</span>,<span class='va'>Z2</span><span class='op'>[</span><span class='va'>ind_cc_est</span>,,drop<span class='op'>=</span><span class='cn'>FALSE</span><span class='op'>]</span><span class='op'>)</span></span>
<span class='r-in'>    <span class='va'>Q_ini_t</span> <span class='op'>&lt;-</span> <span class='va'>res</span><span class='op'>$</span><span class='va'>Q_ini</span></span>
<span class='r-in'>    <span class='va'>Z_ini_t</span> <span class='op'>&lt;-</span> <span class='va'>res</span><span class='op'>$</span><span class='va'>Z_ini</span></span>
<span class='r-in'></span>
<span class='r-in'>    <span class='va'>max_iter</span> <span class='op'>&lt;-</span> <span class='fl'>50</span></span>
<span class='r-in'></span>
<span class='r-in'>    <span class='va'>res</span> <span class='op'>&lt;-</span> <span class='fu'><a href='adg_em.html'>adg_em</a></span><span class='op'>(</span><span class='va'>X2_cc</span>,<span class='va'>Z_ini_t</span>,<span class='va'>Q_ini_t</span>,</span>
<span class='r-in'>                  <span class='va'>max_iter</span>,<span class='va'>err_prob</span>,<span class='va'>must_maxiter</span>,<span class='va'>D_mat</span>,<span class='va'>X1_cc</span><span class='op'>)</span></span>
<span class='r-in'></span>
<span class='r-in'>    <span class='va'>Z_est</span> <span class='op'>&lt;-</span> <span class='va'>res</span><span class='op'>$</span><span class='va'>Z_est</span></span>
<span class='r-in'>    <span class='va'>Z_candi</span> <span class='op'>&lt;-</span> <span class='va'>res</span><span class='op'>$</span><span class='va'>Z_candi</span></span>
<span class='r-in'>    <span class='va'>Q_arr</span>   <span class='op'>&lt;-</span> <span class='va'>res</span><span class='op'>$</span><span class='va'>Q_arr</span></span>
<span class='r-in'></span>
<span class='r-in'>    <span class='va'>Q_est</span> <span class='op'>&lt;-</span> <span class='va'>Q_arr</span><span class='op'>[[</span><span class='fu'><a href='https://rdrr.io/r/base/length.html'>length</a></span><span class='op'>(</span><span class='va'>Q_arr</span><span class='op'>)</span><span class='op'>]</span><span class='op'>]</span></span>
<span class='r-in'>    <span class='fu'><a href='check_complete.html'>check_complete</a></span><span class='op'>(</span><span class='va'>Q_est</span><span class='op'>)</span></span>
<span class='r-in'></span>
<span class='r-in'>    <span class='kw'>if</span> <span class='op'>(</span><span class='fu'><a href='check_complete.html'>check_complete</a></span><span class='op'>(</span><span class='va'>Q_est</span><span class='op'>)</span><span class='op'>$</span><span class='va'>is_complete</span><span class='op'>==</span><span class='fl'>0</span><span class='op'>)</span><span class='op'>{</span></span>
<span class='r-in'>      <span class='va'>Q_est</span><span class='op'>[</span><span class='fl'>1</span><span class='op'>:</span><span class='va'>K2</span>,<span class='op'>]</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/diag.html'>diag</a></span><span class='op'>(</span><span class='fl'>1</span>,<span class='va'>K2</span><span class='op'>)</span></span>
<span class='r-in'>    <span class='op'>}</span></span>
<span class='r-in'></span>
<span class='r-in'>    <span class='va'>Q2_est</span><span class='op'>[[</span><span class='va'>cc</span><span class='op'>]</span><span class='op'>]</span> <span class='op'>&lt;-</span> <span class='va'>Q_est</span></span>
<span class='r-in'></span>
<span class='r-in'></span>
<span class='r-in'>    <span class='co'>## some checks:</span></span>
<span class='r-in'>    <span class='fu'><a href='https://rdrr.io/r/base/table.html'>table</a></span><span class='op'>(</span><span class='fu'><a href='bin2ind.html'>bin2ind</a></span><span class='op'>(</span><span class='va'>Z_ini_t</span><span class='op'>)</span><span class='op'>)</span></span>
<span class='r-in'></span>
<span class='r-in'>    <span class='fu'><a href='https://rdrr.io/r/base/unique.html'>unique</a></span><span class='op'>(</span><span class='va'>Z_est</span><span class='op'>)</span></span>
<span class='r-in'>    <span class='fu'><a href='https://rdrr.io/r/base/table.html'>table</a></span><span class='op'>(</span><span class='fu'><a href='bin2ind.html'>bin2ind</a></span><span class='op'>(</span><span class='va'>Z_est</span><span class='op'>)</span><span class='op'>)</span></span>
<span class='r-in'></span>
<span class='r-in'>    <span class='va'>ind_cc</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/apply.html'>apply</a></span><span class='op'>(</span><span class='va'>Z1</span>,<span class='fl'>1</span>,<span class='kw'>function</span><span class='op'>(</span><span class='va'>v</span><span class='op'>)</span> <span class='fu'><a href='https://rdrr.io/r/base/all.html'>all</a></span><span class='op'>(</span><span class='va'>v</span><span class='op'>==</span><span class='va'>A_set1</span><span class='op'>[</span><span class='va'>cc</span>,<span class='op'>]</span><span class='op'>)</span><span class='op'>)</span></span>
<span class='r-in'>    <span class='fu'><a href='https://rdrr.io/r/base/table.html'>table</a></span><span class='op'>(</span><span class='fu'><a href='bin2ind.html'>bin2ind</a></span><span class='op'>(</span><span class='va'>Z2</span><span class='op'>[</span><span class='va'>ind_cc</span>,<span class='op'>]</span><span class='op'>)</span><span class='op'>)</span></span>
<span class='r-in'>    <span class='co'>## check end.</span></span>
<span class='r-in'></span>
<span class='r-in'>    <span class='co'># no shrinkage: after screening the latent attributes are estimated well.</span></span>
<span class='r-in'>    <span class='va'>A_final</span> <span class='op'>&lt;-</span> <span class='va'>Z_candi</span></span>
<span class='r-in'>    <span class='co'># but in level 1, we used PEM to choose A, plain EM for EBIC.</span></span>
<span class='r-in'></span>
<span class='r-in'>    <span class='fu'><a href='https://rdrr.io/r/base/table.html'>table</a></span><span class='op'>(</span><span class='fu'><a href='bin2ind.html'>bin2ind</a></span><span class='op'>(</span><span class='va'>Z2</span><span class='op'>[</span><span class='va'>ind_cc</span>,<span class='op'>]</span><span class='op'>)</span><span class='op'>)</span></span>
<span class='r-in'>    <span class='fu'><a href='https://rdrr.io/r/base/table.html'>table</a></span><span class='op'>(</span><span class='fu'><a href='bin2ind.html'>bin2ind</a></span><span class='op'>(</span><span class='va'>Z_est</span><span class='op'>)</span><span class='op'>)</span></span>
<span class='r-in'></span>
<span class='r-in'>    <span class='va'>pattern2_est</span><span class='op'>[[</span><span class='va'>cc</span><span class='op'>]</span><span class='op'>]</span> <span class='op'>&lt;-</span> <span class='va'>A_final</span></span>
<span class='r-in'>    <span class='va'>profile2_est</span><span class='op'>[[</span><span class='va'>cc</span><span class='op'>]</span><span class='op'>]</span> <span class='op'>&lt;-</span> <span class='va'>Z_est</span></span>
<span class='r-in'></span>
<span class='r-in'>    <span class='va'>Z_ini2</span><span class='op'>[</span><span class='va'>ind_cc_est</span>,<span class='op'>]</span> <span class='op'>&lt;-</span> <span class='va'>Z_ini_t</span></span>
<span class='r-in'>    <span class='va'>Z_shrink2</span><span class='op'>[</span><span class='va'>ind_cc_est</span>,<span class='op'>]</span> <span class='op'>&lt;-</span> <span class='va'>Z_est</span></span>
<span class='r-in'>  <span class='op'>}</span></span>
<span class='r-in'></span>
<span class='r-in'></span>
<span class='r-in'>  <span class='co'>#</span></span>
<span class='r-in'>  <span class='co'># NEXT: look at estimation results.</span></span>
<span class='r-in'>  <span class='co'>#</span></span>
<span class='r-in'></span>
<span class='r-in'></span>
<span class='r-in'>  <span class='fu'><a href='https://rdrr.io/r/base/sum.html'>sum</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/MathFun.html'>abs</a></span><span class='op'>(</span><span class='va'>profile1</span><span class='op'>-</span><span class='va'>Z1</span><span class='op'>)</span>,<span class='fl'>1</span><span class='op'>)</span></span>
<span class='r-in'></span>
<span class='r-in'>  <span class='fu'><a href='https://rdrr.io/r/graphics/image.html'>image</a></span><span class='op'>(</span><span class='fu'><a href='f.html'>f</a></span><span class='op'>(</span><span class='va'>profile1</span><span class='op'>-</span><span class='va'>Z1</span><span class='op'>)</span><span class='op'>)</span></span>
<span class='r-in'></span>
<span class='r-in'>  <span class='fu'><a href='https://rdrr.io/r/graphics/par.html'>par</a></span><span class='op'>(</span>mfrow<span class='op'>=</span><span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>1</span>,<span class='fl'>2</span><span class='op'>)</span><span class='op'>)</span></span>
<span class='r-in'>  <span class='fu'><a href='https://rdrr.io/r/graphics/image.html'>image</a></span><span class='op'>(</span><span class='fu'><a href='f.html'>f</a></span><span class='op'>(</span><span class='va'>Z_ini2</span><span class='op'>-</span><span class='va'>Z2</span><span class='op'>)</span><span class='op'>)</span></span>
<span class='r-in'>  <span class='fu'><a href='https://rdrr.io/r/graphics/image.html'>image</a></span><span class='op'>(</span><span class='fu'><a href='f.html'>f</a></span><span class='op'>(</span><span class='va'>Z_shrink2</span><span class='op'>-</span><span class='va'>Z2</span><span class='op'>)</span><span class='op'>)</span></span>
<span class='r-in'></span>
<span class='r-in'>  <span class='co'># combine</span></span>
<span class='r-in'>  <span class='fu'><a href='https://rdrr.io/r/graphics/par.html'>par</a></span><span class='op'>(</span>mfrow<span class='op'>=</span><span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>1</span>,<span class='fl'>2</span><span class='op'>)</span><span class='op'>)</span></span>
<span class='r-in'>  <span class='fu'><a href='https://rdrr.io/r/graphics/image.html'>image</a></span><span class='op'>(</span><span class='fu'><a href='f.html'>f</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/cbind.html'>cbind</a></span><span class='op'>(</span><span class='va'>Z_ini1</span>,<span class='va'>Z_ini2</span><span class='op'>)</span><span class='op'>-</span><span class='fu'><a href='https://rdrr.io/r/base/cbind.html'>cbind</a></span><span class='op'>(</span><span class='va'>Z1</span>,<span class='va'>Z2</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span></span>
<span class='r-in'>  <span class='fu'><a href='https://rdrr.io/r/graphics/image.html'>image</a></span><span class='op'>(</span><span class='fu'><a href='f.html'>f</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/cbind.html'>cbind</a></span><span class='op'>(</span><span class='va'>profile1</span>,<span class='va'>Z_shrink2</span><span class='op'>)</span><span class='op'>-</span><span class='fu'><a href='https://rdrr.io/r/base/cbind.html'>cbind</a></span><span class='op'>(</span><span class='va'>Z1</span>,<span class='va'>Z2</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span></span>
<span class='r-in'></span>
<span class='r-in'>  <span class='co'>#combine results from doubly-multireolution clustering</span></span>
<span class='r-in'>  <span class='fu'><a href='https://rdrr.io/r/base/sum.html'>sum</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/MathFun.html'>abs</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/cbind.html'>cbind</a></span><span class='op'>(</span><span class='va'>profile1</span>,<span class='va'>Z_shrink2</span><span class='op'>)</span><span class='op'>-</span><span class='fu'><a href='https://rdrr.io/r/base/cbind.html'>cbind</a></span><span class='op'>(</span><span class='va'>Z1</span>,<span class='va'>Z2</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span></span>
<span class='r-in'>  <span class='va'>Z_multi_res</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/cbind.html'>cbind</a></span><span class='op'>(</span><span class='va'>profile1</span>,<span class='va'>Z_shrink2</span><span class='op'>)</span></span>
<span class='r-in'></span>
<span class='r-in'>  <span class='kw'>for</span> <span class='op'>(</span><span class='va'>cc</span> <span class='kw'>in</span> <span class='fl'>1</span><span class='op'>:</span><span class='va'>C1</span><span class='op'>)</span><span class='op'>{</span></span>
<span class='r-in'>    <span class='va'>ind_cc</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/apply.html'>apply</a></span><span class='op'>(</span><span class='va'>Z1</span>,<span class='fl'>1</span>,<span class='kw'>function</span><span class='op'>(</span><span class='va'>v</span><span class='op'>)</span> <span class='fu'><a href='https://rdrr.io/r/base/all.html'>all</a></span><span class='op'>(</span><span class='va'>v</span><span class='op'>==</span><span class='va'>A_set1</span><span class='op'>[</span><span class='va'>cc</span>,<span class='op'>]</span><span class='op'>)</span><span class='op'>)</span></span>
<span class='r-in'></span>
<span class='r-in'>    <span class='fu'><a href='https://rdrr.io/r/base/print.html'>print</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/table.html'>table</a></span><span class='op'>(</span><span class='fu'><a href='bin2ind.html'>bin2ind</a></span><span class='op'>(</span><span class='va'>Z2</span><span class='op'>[</span><span class='va'>ind_cc</span>,<span class='op'>]</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span></span>
<span class='r-in'>    <span class='fu'><a href='https://rdrr.io/r/base/print.html'>print</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/table.html'>table</a></span><span class='op'>(</span><span class='fu'><a href='bin2ind.html'>bin2ind</a></span><span class='op'>(</span><span class='va'>profile2_est</span><span class='op'>[[</span><span class='va'>cc</span><span class='op'>]</span><span class='op'>]</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span></span>
<span class='r-in'>  <span class='op'>}</span></span>
<span class='r-in'></span>
<span class='r-in'></span>
<span class='r-in'>  <span class='va'>ind_cc_arr</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/vector.html'>vector</a></span><span class='op'>(</span><span class='st'>"list"</span>,<span class='va'>C1</span><span class='op'>)</span></span>
<span class='r-in'>  <span class='fu'><a href='https://rdrr.io/r/grDevices/png.html'>png</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/file.path.html'>file.path</a></span><span class='op'>(</span><span class='va'>production_dir</span>,<span class='st'>"data_level2.png"</span><span class='op'>)</span><span class='op'>)</span></span>
<span class='r-in'>  <span class='fu'><a href='https://rdrr.io/r/graphics/par.html'>par</a></span><span class='op'>(</span>mfrow<span class='op'>=</span><span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>1</span>,<span class='fl'>3</span><span class='op'>)</span><span class='op'>)</span></span>
<span class='r-in'>  <span class='kw'>for</span> <span class='op'>(</span><span class='va'>cc</span> <span class='kw'>in</span> <span class='fl'>1</span><span class='op'>:</span><span class='va'>C1</span><span class='op'>)</span><span class='op'>{</span></span>
<span class='r-in'>    <span class='va'>ind_cc_arr</span><span class='op'>[[</span><span class='va'>cc</span><span class='op'>]</span><span class='op'>]</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/apply.html'>apply</a></span><span class='op'>(</span><span class='va'>Z1</span>,<span class='fl'>1</span>,<span class='kw'>function</span><span class='op'>(</span><span class='va'>v</span><span class='op'>)</span> <span class='fu'><a href='https://rdrr.io/r/base/all.html'>all</a></span><span class='op'>(</span><span class='va'>v</span><span class='op'>==</span><span class='va'>A_set1</span><span class='op'>[</span><span class='va'>cc</span>,<span class='op'>]</span><span class='op'>)</span><span class='op'>)</span></span>
<span class='r-in'>    <span class='fu'><a href='https://rdrr.io/r/graphics/image.html'>image</a></span><span class='op'>(</span><span class='fu'><a href='f.html'>f</a></span><span class='op'>(</span><span class='va'>X2</span><span class='op'>[</span><span class='va'>ind_cc_arr</span><span class='op'>[[</span><span class='va'>cc</span><span class='op'>]</span><span class='op'>]</span>,<span class='op'>]</span><span class='op'>)</span><span class='op'>)</span></span>
<span class='r-in'>  <span class='op'>}</span></span>
<span class='r-in'>  <span class='fu'><a href='https://rdrr.io/r/grDevices/dev.html'>dev.off</a></span><span class='op'>(</span><span class='op'>)</span></span>
<span class='r-in'></span>
<span class='r-in'>  <span class='co'># check tree constraint:</span></span>
<span class='r-in'>  <span class='fu'><a href='https://rdrr.io/r/base/all.html'>all</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/all.html'>all</a></span><span class='op'>(</span><span class='va'>X2</span> <span class='op'>&lt;=</span> <span class='va'>X1</span> <span class='op'><a href='https://rdrr.io/r/base/matmult.html'>%*%</a></span> <span class='va'>D_mat</span><span class='op'>)</span><span class='op'>)</span></span>
<span class='r-in'></span>
<span class='r-in'>  <span class='co'>#look at clustering at the 1st level:</span></span>
<span class='r-in'></span>
<span class='r-in'>  <span class='fu'><a href='https://rdrr.io/r/grDevices/png.html'>png</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/file.path.html'>file.path</a></span><span class='op'>(</span><span class='va'>production_dir</span>,<span class='st'>"clustering_level1.png"</span><span class='op'>)</span><span class='op'>)</span></span>
<span class='r-in'>  <span class='fu'><a href='https://rdrr.io/r/graphics/par.html'>par</a></span><span class='op'>(</span>mfrow<span class='op'>=</span><span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>1</span>,<span class='fl'>2</span><span class='op'>)</span><span class='op'>)</span></span>
<span class='r-in'>  <span class='fu'><a href='https://rdrr.io/r/graphics/image.html'>image</a></span><span class='op'>(</span><span class='fu'><a href='f.html'>f</a></span><span class='op'>(</span><span class='va'>Z_ini1</span><span class='op'>-</span><span class='va'>Z1</span><span class='op'>)</span>,main<span class='op'>=</span><span class='st'>"pattern_ini-pattern_true"</span><span class='op'>)</span></span>
<span class='r-in'>  <span class='fu'><a href='https://rdrr.io/r/graphics/image.html'>image</a></span><span class='op'>(</span><span class='fu'><a href='f.html'>f</a></span><span class='op'>(</span><span class='va'>Z_shrink1</span><span class='op'>-</span><span class='va'>Z1</span><span class='op'>)</span>,main<span class='op'>=</span><span class='st'>"pattern_est-pattern_true"</span><span class='op'>)</span></span>
<span class='r-in'>  <span class='fu'><a href='https://rdrr.io/r/grDevices/dev.html'>dev.off</a></span><span class='op'>(</span><span class='op'>)</span></span>
<span class='r-in'></span>
<span class='r-in'>  <span class='co'># second level clustering:</span></span>
<span class='r-in'>  <span class='fu'><a href='https://rdrr.io/r/grDevices/png.html'>png</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/file.path.html'>file.path</a></span><span class='op'>(</span><span class='va'>production_dir</span>,<span class='st'>"clustering_level2.png"</span><span class='op'>)</span><span class='op'>)</span></span>
<span class='r-in'>  <span class='fu'><a href='https://rdrr.io/r/graphics/par.html'>par</a></span><span class='op'>(</span>mfrow<span class='op'>=</span><span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='va'>C1</span>,<span class='fl'>2</span><span class='op'>)</span><span class='op'>)</span></span>
<span class='r-in'>  <span class='kw'>for</span> <span class='op'>(</span><span class='va'>cc</span> <span class='kw'>in</span> <span class='fl'>1</span><span class='op'>:</span><span class='va'>C1</span><span class='op'>)</span><span class='op'>{</span></span>
<span class='r-in'>    <span class='fu'><a href='https://rdrr.io/r/graphics/image.html'>image</a></span><span class='op'>(</span><span class='fu'><a href='f.html'>f</a></span><span class='op'>(</span><span class='va'>Z_ini2</span><span class='op'>[</span><span class='va'>ind_cc_arr</span><span class='op'>[[</span><span class='va'>cc</span><span class='op'>]</span><span class='op'>]</span>,<span class='op'>]</span><span class='op'>-</span><span class='va'>Z2</span><span class='op'>[</span><span class='va'>ind_cc_arr</span><span class='op'>[[</span><span class='va'>cc</span><span class='op'>]</span><span class='op'>]</span>,<span class='op'>]</span><span class='op'>)</span>,</span>
<span class='r-in'>          main<span class='op'>=</span><span class='fu'><a href='https://rdrr.io/r/base/paste.html'>paste0</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/paste.html'>paste</a></span><span class='op'>(</span><span class='va'>A_set1</span><span class='op'>[</span><span class='va'>cc</span>,<span class='op'>]</span>,collapse <span class='op'>=</span> <span class='st'>""</span><span class='op'>)</span>,<span class='st'>"; FINER 2: pattern_ini-pattern_true"</span><span class='op'>)</span><span class='op'>)</span></span>
<span class='r-in'>    <span class='fu'><a href='https://rdrr.io/r/graphics/image.html'>image</a></span><span class='op'>(</span><span class='fu'><a href='f.html'>f</a></span><span class='op'>(</span><span class='va'>Z_shrink2</span><span class='op'>[</span><span class='va'>ind_cc_arr</span><span class='op'>[[</span><span class='va'>cc</span><span class='op'>]</span><span class='op'>]</span>, <span class='op'>]</span><span class='op'>-</span><span class='va'>Z2</span><span class='op'>[</span><span class='va'>ind_cc_arr</span><span class='op'>[[</span><span class='va'>cc</span><span class='op'>]</span><span class='op'>]</span>, <span class='op'>]</span><span class='op'>)</span>,</span>
<span class='r-in'>          main<span class='op'>=</span><span class='fu'><a href='https://rdrr.io/r/base/paste.html'>paste0</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/paste.html'>paste</a></span><span class='op'>(</span><span class='va'>A_set1</span><span class='op'>[</span><span class='va'>cc</span>,<span class='op'>]</span>,collapse <span class='op'>=</span> <span class='st'>""</span><span class='op'>)</span>,<span class='st'>"; FINER 2: pattern_est-pattern_true"</span><span class='op'>)</span><span class='op'>)</span></span>
<span class='r-in'>  <span class='op'>}</span></span>
<span class='r-in'>  <span class='fu'><a href='https://rdrr.io/r/grDevices/dev.html'>dev.off</a></span><span class='op'>(</span><span class='op'>)</span></span>
<span class='r-in'></span>
<span class='r-in'>  <span class='co'>#</span></span>
<span class='r-in'>  <span class='co'># for flattened pattersn:</span></span>
<span class='r-in'>  <span class='co'>#</span></span>
<span class='r-in'>  <span class='va'>Z_flat</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/cbind.html'>cbind</a></span><span class='op'>(</span><span class='va'>Z1</span>,<span class='va'>Z2</span><span class='op'>)</span></span>
<span class='r-in'>  <span class='va'>A_set_flat</span> <span class='op'>&lt;-</span> <span class='fu'><a href='unique_sort_binmat.html'>unique_sort_binmat</a></span><span class='op'>(</span><span class='va'>Z_flat</span><span class='op'>)</span></span>
<span class='r-in'></span>
<span class='r-in'></span>
<span class='r-in'>  <span class='fu'><a href='https://rdrr.io/r/base/table.html'>table</a></span><span class='op'>(</span><span class='fu'><a href='bin2ind.html'>bin2ind</a></span><span class='op'>(</span><span class='va'>Z_flat</span><span class='op'>)</span><span class='op'>)</span></span>
<span class='r-in'>  <span class='va'>A_set_all</span> <span class='op'>&lt;-</span> <span class='fu'><a href='unique_sort_binmat.html'>unique_sort_binmat</a></span><span class='op'>(</span><span class='va'>Z_flat</span><span class='op'>)</span></span>
<span class='r-in'></span>
<span class='r-in'>  <span class='co'>#### fitting begins:</span></span>
<span class='r-in'>  <span class='co'>## fitting flattened model</span></span>
<span class='r-in'>  <span class='fu'><a href='https://rdrr.io/r/base/Random.html'>set.seed</a></span><span class='op'>(</span><span class='fl'>0513</span><span class='op'>)</span></span>
<span class='r-in'></span>
<span class='r-in'>  <span class='co'># get initial values:</span></span>
<span class='r-in'>  <span class='va'>res</span> <span class='op'>&lt;-</span> <span class='fu'><a href='get_initial_n.html'>get_initial_n</a></span><span class='op'>(</span><span class='va'>N</span>,<span class='va'>Q1</span>,<span class='va'>Z1</span><span class='op'>)</span></span>
<span class='r-in'>  <span class='va'>Q_ini1</span> <span class='op'>&lt;-</span> <span class='va'>res</span><span class='op'>$</span><span class='va'>Q_ini</span></span>
<span class='r-in'>  <span class='va'>Z_ini1</span> <span class='op'>&lt;-</span> <span class='va'>res</span><span class='op'>$</span><span class='va'>Z_ini</span></span>
<span class='r-in'></span>
<span class='r-in'>  <span class='va'>res</span> <span class='op'>&lt;-</span> <span class='fu'><a href='get_initial_n.html'>get_initial_n</a></span><span class='op'>(</span><span class='va'>N</span>,<span class='va'>Q2</span><span class='op'>[[</span><span class='fl'>1</span><span class='op'>]</span><span class='op'>]</span>,<span class='va'>Z2</span><span class='op'>)</span></span>
<span class='r-in'>  <span class='va'>Q_ini2</span> <span class='op'>&lt;-</span> <span class='va'>res</span><span class='op'>$</span><span class='va'>Q_ini</span></span>
<span class='r-in'>  <span class='va'>Z_ini2</span> <span class='op'>&lt;-</span> <span class='va'>res</span><span class='op'>$</span><span class='va'>Z_ini</span></span>
<span class='r-in'></span>
<span class='r-in'>  <span class='va'>K_flat</span> <span class='op'>&lt;-</span> <span class='va'>K1</span><span class='op'>+</span><span class='va'>K2</span></span>
<span class='r-in'></span>
<span class='r-in'>  <span class='va'>Z_flat_ini</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/cbind.html'>cbind</a></span><span class='op'>(</span><span class='va'>Z_ini1</span>,<span class='va'>Z_ini2</span><span class='op'>)</span></span>
<span class='r-in'></span>
<span class='r-in'>  <span class='co'># try different initialization for Q_flat:</span></span>
<span class='r-in'>  <span class='va'>Q_flat_ini</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/cbind.html'>rbind</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/cbind.html'>cbind</a></span><span class='op'>(</span><span class='va'>Q_ini1</span>,<span class='fu'><a href='https://rdrr.io/r/base/matrix.html'>matrix</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/stats/Uniform.html'>runif</a></span><span class='op'>(</span><span class='va'>J1</span><span class='op'>*</span><span class='va'>K2</span><span class='op'>)</span><span class='op'>&lt;</span><span class='fl'>0.5</span>,nrow<span class='op'>=</span><span class='va'>J1</span>,ncol<span class='op'>=</span><span class='va'>K2</span><span class='op'>)</span><span class='op'>)</span>,</span>
<span class='r-in'>                      <span class='fu'><a href='https://rdrr.io/r/base/cbind.html'>cbind</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/matrix.html'>matrix</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/stats/Uniform.html'>runif</a></span><span class='op'>(</span><span class='va'>J1</span><span class='op'>*</span><span class='va'>K2</span><span class='op'>)</span><span class='op'>&lt;</span><span class='fl'>0.5</span>,nrow<span class='op'>=</span><span class='va'>J2</span>,ncol<span class='op'>=</span><span class='va'>K1</span><span class='op'>)</span>,<span class='va'>Q_ini2</span><span class='op'>)</span><span class='op'>)</span></span>
<span class='r-in'></span>
<span class='r-in'>  <span class='co'>## begin real fitting:</span></span>
<span class='r-in'>  <span class='fu'><a href='https://rdrr.io/r/base/Random.html'>set.seed</a></span><span class='op'>(</span><span class='fl'>0513</span><span class='op'>)</span></span>
<span class='r-in'>  <span class='co'># one-stage shrinkage of flattened data</span></span>
<span class='r-in'>  <span class='va'>X</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/cbind.html'>cbind</a></span><span class='op'>(</span><span class='va'>X1</span>,<span class='va'>X2</span><span class='op'>)</span></span>
<span class='r-in'></span>
<span class='r-in'>  <span class='va'>mat_iter</span> <span class='op'>&lt;-</span> <span class='fl'>50</span></span>
<span class='r-in'>  <span class='va'>time1</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/Sys.time.html'>Sys.time</a></span><span class='op'>(</span><span class='op'>)</span></span>
<span class='r-in'>  <span class='va'>res</span> <span class='op'>&lt;-</span> <span class='fu'><a href='adg_em.html'>adg_em</a></span><span class='op'>(</span><span class='va'>X</span>, <span class='va'>Z_flat_ini</span>, <span class='va'>Q_flat_ini</span>, <span class='va'>max_iter</span>, <span class='va'>err_prob</span><span class='op'>)</span> <span class='co'># currently slow.</span></span>
<span class='r-in'>  <span class='fu'><a href='https://rdrr.io/r/base/Sys.time.html'>Sys.time</a></span><span class='op'>(</span><span class='op'>)</span><span class='op'>-</span><span class='va'>time1</span></span>
<span class='r-in'></span>
<span class='r-in'>  <span class='va'>Z_est</span> <span class='op'>&lt;-</span> <span class='va'>res</span><span class='op'>$</span><span class='va'>Z_est</span></span>
<span class='r-in'>  <span class='va'>Z_candi</span> <span class='op'>&lt;-</span> <span class='va'>res</span><span class='op'>$</span><span class='va'>Z_candi</span></span>
<span class='r-in'>  <span class='va'>Q_arr</span>   <span class='op'>&lt;-</span> <span class='va'>res</span><span class='op'>$</span><span class='va'>Q_arr</span></span>
<span class='r-in'></span>
<span class='r-in'>  <span class='va'>Q_est</span> <span class='op'>&lt;-</span> <span class='va'>Q_arr</span><span class='op'>[[</span><span class='fu'><a href='https://rdrr.io/r/base/length.html'>length</a></span><span class='op'>(</span><span class='va'>Q_arr</span><span class='op'>)</span><span class='op'>]</span><span class='op'>]</span></span>
<span class='r-in'></span>
<span class='r-in'>  <span class='fu'><a href='check_complete.html'>check_complete</a></span><span class='op'>(</span><span class='va'>Q_est</span><span class='op'>)</span></span>
<span class='r-in'></span>
<span class='r-in'>  <span class='fu'><a href='unique_sort_binmat.html'>unique_sort_binmat</a></span><span class='op'>(</span><span class='va'>Z_est</span><span class='op'>)</span></span>
<span class='r-in'>  <span class='fu'><a href='https://rdrr.io/r/base/table.html'>table</a></span><span class='op'>(</span><span class='fu'><a href='bin2ind.html'>bin2ind</a></span><span class='op'>(</span><span class='va'>Z_est</span><span class='op'>)</span><span class='op'>)</span></span>
<span class='r-in'></span>
<span class='r-in'>  <span class='co'># check if screened patterns include the true flattened patterns.</span></span>
<span class='r-in'>  <span class='co'># check_pattern(A_set_flat,Z_candi)</span></span>
<span class='r-in'></span>
<span class='r-in'>  <span class='co'># look at clustering</span></span>
<span class='r-in'>  <span class='fu'><a href='https://rdrr.io/r/grDevices/png.html'>png</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/file.path.html'>file.path</a></span><span class='op'>(</span><span class='va'>production_dir</span>,<span class='st'>"clustering_level2_flattened.png"</span><span class='op'>)</span><span class='op'>)</span></span>
<span class='r-in'>  <span class='fu'><a href='https://rdrr.io/r/graphics/par.html'>par</a></span><span class='op'>(</span>mfrow<span class='op'>=</span><span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>1</span>,<span class='fl'>3</span><span class='op'>)</span><span class='op'>)</span></span>
<span class='r-in'>  <span class='fu'><a href='https://rdrr.io/r/graphics/image.html'>image</a></span><span class='op'>(</span><span class='fu'><a href='f.html'>f</a></span><span class='op'>(</span><span class='va'>Z_flat_ini</span><span class='op'>)</span>,main<span class='op'>=</span><span class='st'>"pattern_ini"</span><span class='op'>)</span></span>
<span class='r-in'>  <span class='fu'><a href='https://rdrr.io/r/graphics/image.html'>image</a></span><span class='op'>(</span><span class='fu'><a href='f.html'>f</a></span><span class='op'>(</span><span class='va'>Z_est</span><span class='op'>)</span>,main<span class='op'>=</span><span class='st'>"pattern_est"</span><span class='op'>)</span></span>
<span class='r-in'>  <span class='fu'><a href='https://rdrr.io/r/graphics/image.html'>image</a></span><span class='op'>(</span><span class='fu'><a href='f.html'>f</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/cbind.html'>cbind</a></span><span class='op'>(</span><span class='va'>Z1</span>,<span class='va'>Z2</span><span class='op'>)</span><span class='op'>)</span>,main<span class='op'>=</span><span class='st'>"pattern_true"</span><span class='op'>)</span></span>
<span class='r-in'>  <span class='fu'><a href='https://rdrr.io/r/grDevices/dev.html'>dev.off</a></span><span class='op'>(</span><span class='op'>)</span></span>
<span class='r-in'></span>
<span class='r-in'>  <span class='co'># difference</span></span>
<span class='r-in'>  <span class='fu'><a href='https://rdrr.io/r/grDevices/png.html'>png</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/file.path.html'>file.path</a></span><span class='op'>(</span><span class='va'>production_dir</span>,<span class='st'>"difference_from_truth.png"</span><span class='op'>)</span><span class='op'>)</span></span>
<span class='r-in'>  <span class='fu'><a href='https://rdrr.io/r/graphics/par.html'>par</a></span><span class='op'>(</span>mfrow<span class='op'>=</span><span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>1</span>,<span class='fl'>3</span><span class='op'>)</span><span class='op'>)</span></span>
<span class='r-in'>  <span class='fu'><a href='https://rdrr.io/r/graphics/image.html'>image</a></span><span class='op'>(</span><span class='fu'><a href='f.html'>f</a></span><span class='op'>(</span><span class='va'>Z_flat_ini</span><span class='op'>-</span><span class='fu'><a href='https://rdrr.io/r/base/cbind.html'>cbind</a></span><span class='op'>(</span><span class='va'>Z1</span>,<span class='va'>Z2</span><span class='op'>)</span><span class='op'>)</span>,main<span class='op'>=</span><span class='st'>"initial-true"</span><span class='op'>)</span></span>
<span class='r-in'>  <span class='fu'><a href='https://rdrr.io/r/graphics/image.html'>image</a></span><span class='op'>(</span><span class='fu'><a href='f.html'>f</a></span><span class='op'>(</span><span class='va'>Z_est</span><span class='op'>-</span><span class='fu'><a href='https://rdrr.io/r/base/cbind.html'>cbind</a></span><span class='op'>(</span><span class='va'>Z1</span>,<span class='va'>Z2</span><span class='op'>)</span><span class='op'>)</span>,main<span class='op'>=</span><span class='st'>"FLAT: est-true"</span><span class='op'>)</span></span>
<span class='r-in'>  <span class='fu'><a href='https://rdrr.io/r/graphics/image.html'>image</a></span><span class='op'>(</span><span class='fu'><a href='f.html'>f</a></span><span class='op'>(</span><span class='va'>Z_multi_res</span><span class='op'>-</span><span class='fu'><a href='https://rdrr.io/r/base/cbind.html'>cbind</a></span><span class='op'>(</span><span class='va'>Z1</span>,<span class='va'>Z2</span><span class='op'>)</span><span class='op'>)</span>,main<span class='op'>=</span><span class='st'>"MULTI: est-true"</span><span class='op'>)</span></span>
<span class='r-in'>  <span class='fu'><a href='https://rdrr.io/r/grDevices/dev.html'>dev.off</a></span><span class='op'>(</span><span class='op'>)</span></span>
<span class='r-in'></span>
<span class='r-in'>  <span class='co'># # look at Q</span></span>
<span class='r-in'>  <span class='co'># png(file.path(production_dir,"Q_flat.png"))</span></span>
<span class='r-in'>  <span class='co'># par(mfrow=c(C1,3))</span></span>
<span class='r-in'>  <span class='co'># image(f(Q_flat_ini),main="Q flat ini")</span></span>
<span class='r-in'>  <span class='co'># image(f(Q_est),main="FLAT: est")</span></span>
<span class='r-in'>  <span class='co'># image(f(rbind(cbind(Q1,matrix(0,J1,K2)),</span></span>
<span class='r-in'>  <span class='co'>#               cbind(matrix(0,J2,K1),Q2[[1]]))),main="MULTI: truth") # &lt;-- change to same Q20</span></span>
<span class='r-in'>  <span class='co'># dev.off()</span></span>
<span class='r-in'></span>
<span class='r-in'>  <span class='fu'><a href='https://rdrr.io/r/base/save.html'>save.image</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/file.path.html'>file.path</a></span><span class='op'>(</span><span class='va'>production_dir</span>,<span class='st'>"example.RDATA"</span><span class='op'>)</span><span class='op'>)</span></span>
<span class='r-in'></span>
<span class='r-in'><span class='op'>}</span></span>
<span class='r-in'></span>
<span class='r-in'></span>
<span class='r-in'></span>
</code></pre></div>
  </div>
  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <nav id="toc" data-toggle="toc" class="sticky-top">
      <h2 data-toc-skip>Contents</h2>
    </nav>
  </div>
</div>


      <footer>
      <div class="copyright">
  <p><p>Developed by Zhenke Wu, Yuqi Gu, Gongjun Xu.</p></p>
</div>

<div class="pkgdown">
  <p><p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 1.6.1.9001.</p></p>
</div>

      </footer>
   </div>

  


  

  </body>
</html>


